import "@k8s/api/core/v1/ConfigMap.pkl"
import "@k8s/api/core/v1/Namespace.pkl"
import "@k8s/K8sResource.pkl"

hidden arc_runner_namespace = "arc-runners"

resources = new Listing {
  new Namespace {
    metadata {
      name = arc_runner_namespace
    }
  }
  new ConfigMap {
    metadata {
      name = "gha_hook_job_started"
      namespace = arc_runner_namespace
    }
    data {
      ["hook_job_started.sh"] =
        """
        set -eux
        echo "hello world"
        echo $FOO
        """
    }
  }
}

output {
  value = resources
  renderer = (K8sResource.output.renderer as YamlRenderer) {
    isStream = true
  }
  files {
    ["configs.yaml"] {
      value = resources
      renderer = (K8sResource.output.renderer as YamlRenderer) {
        isStream = true
      }
    }
    ["kustomization.yaml"] {
      value = new {
        apiVersion = "kustomize.config.k8s.io/v1beta1"
        kind = "Kustomization"
        resources = new Listing {
          "configs.yaml"
        }
      }
      renderer = (K8sResource.output.renderer as YamlRenderer) {
        isStream = false
      }
    }
  }
}
