import "@k8s/api/core/v1/ConfigMap.pkl"
import "@k8s/api/core/v1/Secret.pkl"
import "@k8s/api/core/v1/Namespace.pkl"
import "@k8s/K8sResource.pkl"

hidden arc_runner_namespace = "arc-runners"
hidden arc_runner_secret_name = "arc-github-app-secrets"
hidden arc_runner_hook_job_configmap_name = "gha-hook-job-started"

resources = new Listing {
  new Namespace {
    metadata {
      name = arc_runner_namespace
    }
  }
  new ConfigMap {
    metadata {
      name = arc_runner_hook_job_configmap_name
      namespace = arc_runner_namespace
    }
    data {
      ["hook_job_started.sh"] =
        """
        set -eux
        echo "hello world"
        pwd
        ls -la
        echo $FOO
        """
    }
  } 
}

secrets = new Listing {
  new Secret {
    metadata {
      name = arc_runner_secret_name
      namespace = arc_runner_namespace
    }
    data {
      ["github_app_id"] = read("sops:/ARC_APP_github_app_id").text.base64
      ["github_app_private_key"] = read("sops:/ARC_APP_github_app_private_key").text.base64
      ["github_app_installation_id"] = read("sops:/ARC_APP_github_app_installation_id").text.base64
    }
  } 
}

output {
  value = resources
  renderer = (K8sResource.output.renderer as YamlRenderer) {
    isStream = true
  }
  files {
    ["configs.yaml"] {
      value = resources
      renderer = (K8sResource.output.renderer as YamlRenderer) {
        isStream = true
      }
    }
    ["kustomization.yaml"] {
      value = new {
        apiVersion = "kustomize.config.k8s.io/v1beta1"
        kind = "Kustomization"
        resources = new Listing {
          "configs.yaml"
          "secrets.yaml"
        }
      }
      renderer = (K8sResource.output.renderer as YamlRenderer) {
        isStream = false
      }
    }
    ["secrets.yaml"] {
      value = secrets
      renderer = (K8sResource.output.renderer as YamlRenderer) {
        isStream = true
      }
    }
  }
}
