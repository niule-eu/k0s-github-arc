import "@k8s/api/core/v1/Namespace.pkl"
import "@k8s/K8sResource.pkl"

hidden lpp_namespace = "local-path-provisioner"
hidden lpp_helm_chart_name = "local-path-provisioner"
hidden lpp_helm_chart_url = "oci://dp.apps.rancher.io/charts/local-path-provisioner"
hidden lpp_helm_chart_version = "0.0.33"

resources: Listing = new { 
  new Namespace {
    metadata {
      name = lpp_namespace
    }
  }
  new {
    apiVersion = "source.toolkit.fluxcd.io/v1"
    kind = "GitRepository"
    metadata {
      name = lpp_helm_chart_name
      namespace = "flux-system"
    }
    spec {
      interval = "10m"
      url = "https://github.com/rancher/local-path-provisioner.git"
      ref {
        tag = "v0.0.33"
      }
    }
  }
  new {
    apiVersion = "helm.toolkit.fluxcd.io/v2"
    kind = "HelmRelease"
    metadata {
      name = lpp_helm_chart_name
      namespace = lpp_namespace
    }
    spec {
      interval = "10m"
      chart {
        spec {
          chart = "./deploy/chart/local-path-provisioner"
          sourceRef {
            kind = "GitRepository"
            name = lpp_helm_chart_name
            namespace = "flux-system"
          }
          interval = "10m"
        }
      }
      values {
        storageClass {
          defaultClass = true
        }
      }
    }
  }
}

output {
  value = resources
  renderer = (K8sResource.output.renderer as YamlRenderer) {
    isStream = true
  }
  files {
    ["local-path-provisioner.yaml"] {
      value = resources
      renderer = (K8sResource.output.renderer as YamlRenderer) {
        isStream = true
      }
    }
    // ["kustomization.yaml"] {
    //   value = new {        
    //     apiVersion = "kustomize.config.k8s.io/v1beta1"
    //     kind = "Kustomization"
    //     resources = new Listing {
    //       "local-path-provisioner.yaml"
    //     }
    //   }
    //   renderer = (K8sResource.output.renderer as YamlRenderer) {
    //     isStream = false
    //   }
    // }
  }
}