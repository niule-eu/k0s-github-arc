import "@k8s/K8sResource.pkl"
import* "*.pkl" as Resources

local resources_filtered = Resources.toMap().filter((key, _) -> key != "kustomization.pkl")

local allFiles : Mapping<String, FileOutput> =
  resources_filtered.fold(
    new Mapping<String, FileOutput> {}, 
    (acc, key, value) -> 
      (acc) { ...value.output.files!! }
  )

output {
  value = allFiles.keys.toDynamic()
  files = (allFiles) {
    ["kustomization.yaml"] {
      value = new {        
        apiVersion = "kustomize.config.k8s.io/v1beta1"
        kind = "Kustomization"
        resources = new Listing {
          ...allFiles.keys
        }
      }
      renderer = (K8sResource.output.renderer as YamlRenderer) {
        isStream = false
      }
    }    
  }
}