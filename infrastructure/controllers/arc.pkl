import "@k8s/api/core/v1/Namespace.pkl"
import "@k8s/K8sResource.pkl"

hidden arc_controller_version = "0.13.0"
hidden arc_controller_namespace = "arc-systems"
hidden arc_controller_labels = new Mapping<String, String> {
  ["app.kubernetes.io/name"] = "action-runner-controller-controller"
  ["app.kubernetes.io/part-of"] = "action-runner-controller"
  ["app.kubernetes.io/component"] = "controller"
  ["app.kubernetes.io/managed-by"] = "helm"
  ["app.kubernetes.io/version"] = arc_controller_version
}
hidden arc_controller_helm_chart_name = "gha-runner-scale-set-controller"

resources: Listing = new { 
  new Namespace {
    metadata {
      name = arc_controller_namespace
      labels = arc_controller_labels
    }
  }
  new {
    apiVersion = "source.toolkit.fluxcd.io/v1"
    kind = "OCIRepository"
    metadata {
      name = arc_controller_helm_chart_name
      namespace = "flux-system"
      labels = arc_controller_labels
    }
    spec {
      interval = "5m"
      url = "oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set-controller"
      ref {
        semver = "0.13.0"
      }
    }
  }
  new {
    apiVersion = "helm.toolkit.fluxcd.io/v2"
    kind = "HelmRelease"
    metadata {
      name = arc_controller_helm_chart_name
      namespace = arc_controller_namespace
      labels = arc_controller_labels
    }
    spec {
      interval = "10m"
      chartRef {
        kind = "OCIRepository"
        name = arc_controller_helm_chart_name
        namespace = "flux-system"
      }
    }
  }
}

output {
  value = resources
  renderer = (K8sResource.output.renderer as YamlRenderer) {
    isStream = true
  }
  files {
    ["arc-controller.yaml"] {
      value = resources
      renderer = (K8sResource.output.renderer as YamlRenderer) {
        isStream = true
      }
    }
    ["kustomization.yaml"] {
      value = new {        
        apiVersion = "kustomize.config.k8s.io/v1beta1"
        kind = "Kustomization"
        resources = new Listing {
          "arc-controller.yaml"
        }
      }
      renderer = (K8sResource.output.renderer as YamlRenderer) {
        isStream = false
      }
    }
  }
}